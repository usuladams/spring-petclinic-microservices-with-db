- hosts: role_master
  tasks:

  - name: Create .docker folder
    file:
      path: /home/ubuntu/.docker
      state: directory
      mode: '0755'

  - name: copy the docker config file
    become: yes
    copy: 
      src: $JENKINS_HOME/.docker/config.json
      dest: /home/ubuntu/.docker/config.json

  - name: deploy petclinic application
    shell: |
      kubectl create ns petclinic-dev

      kubectl delete secret gcp-artifact-registry -n petclinic-dev || true

      cat <<EOF > /home/ubuntu/.docker/config.json
      {
        "auths": {
          "europe-west3-docker.pkg.dev": {
            "username": "_json_key",
            "password": $(cat /tmp/gcp-sa.json),
            "email": "usul.adem@gmail.com"
          }
        }
      }
      EOF

      kubectl create secret generic gcp-artifact-registry -n petclinic-dev \
        --from-file=.dockerconfigjson=/home/ubuntu/.docker/config.json \
        --type=kubernetes.io/dockerconfigjson



      helm upgrade --install \
          petclinic-app-release oci://${LOCATION}-docker.pkg.dev/${PROJECT_ID}/${HELM_CHART_REPO_NAME}/petclinic_chart \
          --version ${BUILD_NUMBER} --namespace petclinic-dev
